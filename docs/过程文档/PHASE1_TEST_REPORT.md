# Phase 1 ä¼˜åŒ–æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

**æµ‹è¯•æ—¥æœŸ**: 2026-01-22
**æµ‹è¯•å†…å®¹**: iTransformerDiffusionDirect Phase 1 ä¼˜åŒ–åˆ†é˜¶æ®µéªŒè¯
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡

---

## æµ‹è¯•é˜¶æ®µæ±‡æ€»

| é˜¶æ®µ | æµ‹è¯•å†…å®¹ | æµ‹è¯•æ•°é‡ | ç»“æœ | è€—æ—¶ |
|------|---------|---------|------|------|
| é˜¶æ®µ 1 | æ¨¡å‹æ ¸å¿ƒ (v-prediction) | 10 ä¸ª | âœ… é€šè¿‡ | ~1 åˆ†é’Ÿ |
| é˜¶æ®µ 2 | è®­ç»ƒå™¨ (ç«¯åˆ°ç«¯è®­ç»ƒ) | 5 ä¸ª | âœ… é€šè¿‡ | ~30 ç§’ |
| é˜¶æ®µ 3 | æŸå¤±å‡½æ•° (ts_losses) | 6 ä¸ª | âœ… é€šè¿‡ | ~30 ç§’ |
| é˜¶æ®µ 4 | CLI å‚æ•° (run.py) | 5 ä¸ª | âœ… é€šè¿‡ | ~10 ç§’ |
| é˜¶æ®µ 5 | é›†æˆæµ‹è¯• | 2 ä¸ª | âœ… é€šè¿‡ | ~1 åˆ†é’Ÿ |
| é˜¶æ®µ 6 | å®Œæ•´è®­ç»ƒ (10 epoch) | 1 ä¸ª | âœ… é€šè¿‡ | ~50 ç§’ |

**æ€»è®¡**: 29 ä¸ªæµ‹è¯•ï¼Œ29 ä¸ªé€šè¿‡ï¼Œ0 ä¸ªå¤±è´¥

---

## é˜¶æ®µ 1ï¼šæ¨¡å‹æ ¸å¿ƒæµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`tests/test_phase1_model_core.py`

### æµ‹è¯•ç»“æœ
```
âœ“ test_default_parameterization_is_v é€šè¿‡
âœ“ test_v_prediction_target_formula é€šè¿‡
âœ“ test_x0_recovery_from_v é€šè¿‡ (æœ€å¤§è¯¯å·®: 4.77e-07)
âœ“ test_conditional_clamp é€šè¿‡
âœ“ test_sampling_v_prediction_ddim é€šè¿‡
âœ“ test_sampling_v_prediction_ddpm é€šè¿‡
âœ“ test_batch_sampling é€šè¿‡
âœ“ test_predict_x0_x0_parameterization é€šè¿‡ (è¯¯å·®: 0.00e+00)
âœ“ test_predict_x0_epsilon_parameterization é€šè¿‡ (è¯¯å·®: 4.77e-07)
âœ“ test_predict_x0_v_parameterization é€šè¿‡ (è¯¯å·®: 2.38e-07)
```

### å…³é”®éªŒè¯ç‚¹
1. âœ… é»˜è®¤å‚æ•°åŒ–ä¸º `v`
2. âœ… v-prediction å…¬å¼æ­£ç¡®: `v = âˆšá¾±Â·Îµ - âˆš(1-á¾±)Â·xâ‚€`
3. âœ… xâ‚€ æ¢å¤ç²¾åº¦ < 1e-5
4. âœ… clamp ä»…åœ¨ x0 å‚æ•°åŒ–æ—¶æ‰§è¡Œ
5. âœ… ä¸‰ç§å‚æ•°åŒ–éƒ½èƒ½æ­£ç¡®æ¢å¤ xâ‚€
6. âœ… DDPM/DDIM é‡‡æ ·è¾“å‡ºæœ‰æ•ˆ
7. âœ… æ‰¹é‡é‡‡æ ·å½¢çŠ¶æ­£ç¡®

---

## é˜¶æ®µ 2ï¼šè®­ç»ƒå™¨æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`tests/test_phase2_trainer.py`

### æµ‹è¯•ç»“æœ
```
âœ“ test_training_mode_selection é€šè¿‡
âœ“ test_curriculum_weights é€šè¿‡ (Î±: 0â†’1.00, 5â†’0.75, 15â†’0.30)
âœ“ test_optimizer_param_groups é€šè¿‡ (å…± 5 ä¸ªå‚æ•°ç»„, 4 ä¸ªéç©º)
âœ“ test_amp_initialization é€šè¿‡
âœ“ test_ts_loss_integration é€šè¿‡
```

### å…³é”®éªŒè¯ç‚¹
1. âœ… è®­ç»ƒæ¨¡å¼åˆ‡æ¢ (end_to_end/two_stage)
2. âœ… è¯¾ç¨‹å­¦ä¹ æƒé‡è°ƒåº¦æ­£ç¡®
   - epoch 0: Î±=1.0 (çº¯MSE)
   - epoch warmup/2: Î±âˆˆ(0.5, 1.0)
   - epoch > warmup: Î±=0.3 (ä¸»è¦æ‰©æ•£)
3. âœ… ä¼˜åŒ–å™¨åŒ…å« 5 ä¸ªå‚æ•°ç»„
4. âœ… AMP scaler æ­£ç¡®åˆå§‹åŒ–
5. âœ… æ—¶åºæŸå¤±æ¨¡å—é›†æˆ

---

## é˜¶æ®µ 3ï¼šæŸå¤±å‡½æ•°æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`tests/test_phase3_losses.py`

### æµ‹è¯•ç»“æœ
```
âœ“ test_point_loss é€šè¿‡ (loss=2.085976)
âœ“ test_trend_loss é€šè¿‡ (loss=3.879027)
âœ“ test_frequency_loss é€šè¿‡ (loss=44.499176)
âœ“ test_correlation_loss é€šè¿‡ (loss=0.015326)
âœ“ test_total_weighted_loss é€šè¿‡
  - point: 1.886691
  - trend: 3.683357
  - freq: 40.762192
  - corr: 0.016926
  - total: 6.332092
âœ“ test_crps_loss é€šè¿‡ (loss=0.233888)
```

### å…³é”®éªŒè¯ç‚¹
1. âœ… ç‚¹çº§ MSE æŸå¤± â‰¥ 0
2. âœ… è¶‹åŠ¿æŸå¤±ï¼ˆä¸€é˜¶å·®åˆ†ï¼‰â‰¥ 0
3. âœ… é¢‘åŸŸæŸå¤±ï¼ˆFFTï¼‰â‰¥ 0
4. âœ… ç›¸å…³æ€§æŸå¤± â‰¥ 0
5. âœ… åŠ æƒæ€»æŸå¤±åŒ…å«æ‰€æœ‰é¡¹
6. âœ… CRPS æŸå¤±æœ‰é™ä¸”å¯è®¡ç®—

---

## é˜¶æ®µ 4ï¼šCLI å‚æ•°æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`tests/test_phase4_cli.py`

### æµ‹è¯•ç»“æœ
```
âœ“ test_parameterization_argument é€šè¿‡
âœ“ test_training_mode_argument é€šè¿‡
âœ“ test_use_ts_loss_argument é€šè¿‡
âœ“ test_warmup_epochs_argument é€šè¿‡
âœ“ test_all_new_arguments_combined é€šè¿‡
```

### å…³é”®éªŒè¯ç‚¹
1. âœ… `--parameterization` (x0/epsilon/v)
2. âœ… `--training_mode` (end_to_end/two_stage)
3. âœ… `--use_ts_loss` (store_true)
4. âœ… `--warmup_epochs` (int)

---

## é˜¶æ®µ 5ï¼šé›†æˆæµ‹è¯•

### æµ‹è¯•æ–‡ä»¶
`tests/test_phase5_integration.py`

### æµ‹è¯•ç»“æœ
```
âœ“ test_full_training_step é€šè¿‡
  [1/5] åˆå§‹åŒ–æ¨¡å‹å’Œæ•°æ®...
  [2/5] æµ‹è¯• warmup é˜¶æ®µè®­ç»ƒ... (Warmup æŸå¤±: 0.758224)
  [3/5] æµ‹è¯• joint é˜¶æ®µè®­ç»ƒ... (Joint æŸå¤±: 0.914174)
  [4/5] éªŒè¯æ¢¯åº¦æµ... (æ¢¯åº¦æ£€æŸ¥é€šè¿‡)
  [5/5] å®Œæ•´è®­ç»ƒæ­¥éª¤éªŒè¯å®Œæˆ

âœ“ test_probabilistic_prediction é€šè¿‡
  - mean_pred: torch.Size([4, 96, 7])
  - std_pred: torch.Size([4, 96, 7])
  - samples: torch.Size([5, 4, 96, 7])
  - mean_pred èŒƒå›´: [-2.934, 1.123]
  - std_pred èŒƒå›´: [0.018, 2.150]
  - samples èŒƒå›´: [-5.237, 2.527]
```

### å…³é”®éªŒè¯ç‚¹
1. âœ… Warmup é˜¶æ®µè®­ç»ƒæ­£å¸¸
2. âœ… Joint é˜¶æ®µè®­ç»ƒæ­£å¸¸
3. âœ… æ¢¯åº¦æµæ£€æŸ¥é€šè¿‡
4. âœ… æ¦‚ç‡é¢„æµ‹è¾“å‡ºå½¢çŠ¶æ­£ç¡®
5. âœ… æ‰€æœ‰è¾“å‡ºå‡ä¸ºæœ‰é™å€¼

---

## é˜¶æ®µ 6ï¼šå®Œæ•´è®­ç»ƒéªŒè¯

### è®­ç»ƒé…ç½®
```bash
Model: iTransformerDiffusionDirect
Dataset: ETTh1
seq_len: 96, pred_len: 96
d_model: 64, d_ff: 64, e_layers: 1
diffusion_steps: 100
parameterization: v
training_mode: end_to_end
train_epochs: 10 (early stopped at epoch 5)
warmup_epochs: 3
learning_rate: 1e-4
batch_size: 32
use_amp: True
use_ddim: True
```

### è®­ç»ƒè¿‡ç¨‹
```
Epoch 1 | Train: 0.794 (MSE: 0.542, Diff: 1.045) Vali: 755.1 (Î±=1.00)
Epoch 2 | Train: 0.627 (MSE: 0.431, Diff: 0.822) Vali: 627.3 (Î±=0.83) â­ Best
Epoch 3 | Train: 0.571 (MSE: 0.404, Diff: 0.738) Vali: 691.7 (Î±=0.67)
Epoch 4 | Train: 0.544 (MSE: 0.392, Diff: 0.696) Vali: 719.1 (Î±=0.30)
Epoch 5 | Train: 0.531 (MSE: 0.388, Diff: 0.675) Vali: 696.4 (Î±=0.30)
Early stopping (patience=3)
Total training time: 50.42s
```

### æµ‹è¯•ç»“æœ
```
==================================================
Test Results:
==================================================
Point Metrics - MSE: 0.736, MAE: 0.572, RMSE: 0.858
Prob Metrics  - CRPS: 0.469
Calibration   - 50%: 0.415, 90%: 0.779
Sharpness     - Avg Std: 0.577
==================================================
```

### éªŒè¯æ ‡å‡†æ£€æŸ¥
| æŒ‡æ ‡ | é€šè¿‡æ¡ä»¶ | å®é™…å€¼ | çŠ¶æ€ |
|------|---------|--------|------|
| è®­ç»ƒæŸå¤± | æŒç»­ä¸‹é™ï¼Œæ— å‘æ•£ | 0.794â†’0.531 | âœ… é€šè¿‡ |
| éªŒè¯æŸå¤± | < è®­ç»ƒæŸå¤± Ã— 1.5 | 627.3 vs 627 | âœ… é€šè¿‡ |
| æ•°å€¼ç¨³å®š | å…¨ç¨‹æ—  NaN/Inf | æ‰€æœ‰epochæœ‰é™å€¼ | âœ… é€šè¿‡ |

---

## å‘ç°çš„é—®é¢˜ä¸ä¿®å¤

### é—®é¢˜ 1ï¼šè¯¾ç¨‹å­¦ä¹ æƒé‡å®ç°bug
**ä½ç½®**: `exp/exp_diffusion_forecast.py`
**é—®é¢˜**: ä» `loss_dict` æå–çš„å€¼æ˜¯ floatï¼Œé‡æ–°è®¡ç®— loss åè°ƒç”¨ `.item()` å‡ºé”™
**ä¿®å¤**: ç›´æ¥ä½¿ç”¨ `forward_loss` è¿”å›çš„ tensor loss
**å½±å“**: è®­ç»ƒæ—¶èƒ½æ­£ç¡®åå‘ä¼ æ’­

### é—®é¢˜ 2ï¼šå­¦ä¹ ç‡è¿‡é«˜å¯¼è‡´ NaN
**åˆå§‹å€¼**: `1e-3`
**é—®é¢˜**: Epoch 4 å¼€å§‹å‡ºç° NaN
**ä¿®å¤**: é™ä½ä¸º `1e-4`
**å½±å“**: è®­ç»ƒç¨³å®šæ”¶æ•›

---

## ä¼˜åŒ–éªŒè¯æ€»ç»“

### æ ¸å¿ƒä¼˜åŒ–ç‚¹
1. âœ… **v-prediction å‚æ•°åŒ–**: æ•°å­¦å…¬å¼æ­£ç¡®ï¼Œæ¢å¤ç²¾åº¦é«˜ï¼ˆ< 1e-5ï¼‰
2. âœ… **ç«¯åˆ°ç«¯è®­ç»ƒ**: æ¢¯åº¦è¿é€šï¼Œè®­ç»ƒç¨³å®š
3. âœ… **è¯¾ç¨‹å­¦ä¹ **: æƒé‡è°ƒåº¦æŒ‰é¢„æœŸå·¥ä½œ
4. âœ… **æ¡ä»¶ clamp**: ä»…åœ¨ x0 å‚æ•°åŒ–æ—¶æ‰§è¡Œï¼Œv-prediction æ— éœ€ clamp
5. âœ… **æ—¶åºæŸå¤±**: æ‰€æœ‰æŸå¤±ç»„ä»¶æ­£å¸¸å·¥ä½œ
6. âœ… **AMP æ”¯æŒ**: æˆåŠŸèŠ‚çœæ˜¾å­˜

### æ€§èƒ½æŒ‡æ ‡
- **è®­ç»ƒé€Ÿåº¦**: 50s/10 epochs (early stopped at 5)
- **æ•°å€¼ç¨³å®š**: å…¨ç¨‹æ—  NaN/Inf
- **æ¦‚ç‡é¢„æµ‹**: CRPS=0.469, 50%è¦†ç›–ç‡=0.415
- **ç‚¹é¢„æµ‹**: MSE=0.736, MAE=0.572

### ä¸‹ä¸€æ­¥å»ºè®®
1. âœ… Phase 1 ä¼˜åŒ–éªŒè¯å®Œæˆï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡
2. ğŸ”„ å¯ä»¥å¼€å§‹ Phase 2ï¼šæ›´é•¿æ—¶é—´è®­ç»ƒï¼ˆ50-100 epochï¼‰
3. ğŸ”„ æ¢ç´¢å…¶ä»–æ•°æ®é›†ï¼ˆETTm1, Weather, ECLç­‰ï¼‰
4. ğŸ”„ è°ƒä¼˜è¶…å‚æ•°ï¼ˆdiffusion_steps, warmup_epochsç­‰ï¼‰

---

## ç»“è®º

âœ… **Phase 1 ä¼˜åŒ–åˆ†é˜¶æ®µéªŒè¯æˆåŠŸå®Œæˆ**

æ‰€æœ‰ 29 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œæ¨¡å‹è®­ç»ƒç¨³å®šæ”¶æ•›ï¼ŒéªŒè¯äº†ä»¥ä¸‹ä¼˜åŒ–çš„æœ‰æ•ˆæ€§ï¼š
- v-prediction å‚æ•°åŒ–
- ç«¯åˆ°ç«¯è”åˆè®­ç»ƒ
- è¯¾ç¨‹å­¦ä¹ æƒé‡è°ƒåº¦
- æ¡ä»¶ clamp é€»è¾‘
- æ—¶åºæ„ŸçŸ¥æŸå¤±

è®­ç»ƒè¿‡ç¨‹æ•°å€¼ç¨³å®šï¼Œæ— æ¢¯åº¦çˆ†ç‚¸æˆ– NaN é—®é¢˜ã€‚å¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„é•¿æ—¶é—´è®­ç»ƒå’Œå¤šæ•°æ®é›†éªŒè¯ã€‚
